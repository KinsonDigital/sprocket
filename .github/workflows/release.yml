name: ðŸš€Release
run-name: ${{ vars.PROJECT_NAME }} ${{ inputs.release-type }} Release ${{ inputs.dry-run == true && '(Dry Run)' || '' }}


defaults:
  run:
    shell: pwsh


on:
  workflow_dispatch:
    inputs:
      release-type:
        description: The type of release.  Choose 'Preview' or 'Production'.
        required: true
        type: choice
        options: [Preview, Production]
      dry-run:
        required: false
        description: Dry Run (if true, the release will not be created)
        default: false
        type: boolean


jobs:
  get_version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        working-directory: ${{ github.workspace }}
        run: |
          $scriptPath = "${{ github.workspace }}/.github/cicd/scripts/get-version.ts";

          deno run -R -W -E "$scriptPath";


  validate_release:
    name: Validate Workflow Inputs
    runs-on: ubuntu-latest
    needs: get_version
    steps:
      - name: Validate Workflow Inputs
        run: |
          $branch = "${{ github.ref }}".TrimStart('refs/heads/');
          $expectedPrevBranch = "${{ vars.PREV_RELEASE_BRANCH }}".Trim();
          $expectedProdBranch = "${{ vars.PROD_RELEASE_BRANCH }}".Trim();

          if ($expectedPrevBranch -eq "") {
            Write-Host "::error::The PREV_RELEASE_BRANCH variable is not set.";
            exit 1;
          }

          if ($expectedProdBranch -eq "") {
            Write-Host "::error::The PROD_RELEASE_BRANCH variable is not set.";
            exit 1;
          }

          if ($branch -ne $expectedPrevBranch -and $branch -ne $expectedProdBranch) {
            Write-Host "::error::Releases are only allowed to be run on '$expectedPrevBranch' or '$expectedProdBranch' branches.";
            exit 1;
          }

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Version Does Not Exist
        env:
          OWNER_NAME: "${{ vars.ORGANIZATION_NAME }}"
          REPO_NAME: "${{ vars.PROJECT_NAME }}"
          VERSION_TYPE: "${{ inputs.release-type }}"
          VERSION: "${{ needs.get_version.outputs.version }}"
          GITHUB_TOKEN: "${{ secrets.CICD_TOKEN }}"
        run: |
          $scriptPath = "${{ github.workspace }}/.github/cicd/scripts/version-checker.ts";

          deno run `
          -E `
          -N `
          --allow-run "$scriptPath";

      - name: Release Notes Exist
        env:
          RELEASE_TYPE: "${{ inputs.release-type }}"
          VERSION: "${{ needs.get_version.outputs.version }}"
        run: |
          $scriptPath = "${{ github.workspace }}/.github/cicd/scripts/check-release-notes.ts";

          deno run -E -R "$scriptPath";


  release:
    name: Run ${{ inputs.release-type }} Release
    runs-on: ubuntu-latest
    needs: [get_version, validate_release]
    steps:
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Check
        id: deno-check
        continue-on-error: true
        run: deno check **/*/*.ts;

      - name: Run Lint
        id: deno-lint
        continue-on-error: true
        run: deno lint;

      - name: Deno Format
        id: deno-format
        continue-on-error: true
        run: deno fmt --check ./**/*.ts;

      - name: Run Tests
        id: deno-tests
        continue-on-error: true
        run: deno test -R ./tests/*Tests.ts;

      - name: Validate Checks
        run: |
          $lintFailed = "${{ steps.deno-lint.outcome }}" -eq "failure";
          $formatFailed = "${{ steps.deno-format.outcome }}" -eq "failure";
          $checkFailed = "${{ steps.deno-check.outcome }}" -eq "failure";
          $testsFailed = "${{ steps.deno-tests.outcome }}" -eq "failure";

          if ($lintFailed) {
            Write-Host "::error::The lint check has failed.";
          }

          if ($formatFailed) {
            Write-Host "::error::The format has failed.";
          }

          if ($checkFailed) {
            Write-Host "::error::The check has failed.";
          }

          if ($testsFailed) {
            Write-Host "::error::The tests have failed.";
          }

          if ($lintFailed -or $formatFailed -or $checkFailed -or $testsFailed) {
            exit "${{ inputs.dry-run }}" -eq "true" ? 0 : 1;
          }

      - name: Publish To JSR
        if: ${{ inputs.dry-run == false }}
        run: deno publish;

      - name: Process Release Type
        id: processed_release_type
        run: |
          $releaseType = "${{ inputs.release-type }}".Trim().ToLower();
          "release-type=$releaseType" >> $env:GITHUB_OUTPUT;

      - name: Creating ${{ inputs.release-type }} GitHub Release
        if: ${{ inputs.dry-run == false }}
        uses: softprops/action-gh-release@v2
        with: 
          name: "ðŸš€${{ inputs.release-type }} Release - ${{ needs.get_version.outputs.version }}" 
          body_path: "${{ github.workspace }}/ReleaseNotes/${{ steps.processed_release_type.outputs.release-type }}-releases/Release-Notes-v${{ needs.get_version.outputs.version }}.md"
          files: "${{ github.workspace }}/ReleaseNotes/${{ steps.processed_release_type.outputs.release-type }}-releases/Release-Notes-v${{ needs.get_version.outputs.version }}.md"
          tag_name: "v${{ needs.get_version.outputs.version }}"
          prerelease: ${{ inputs.release-type == 'Preview' }}
          draft: false

      - name: Close Milestone ${{ needs.get_version.outputs.version }}
        if: ${{ inputs.dry-run == false }}
        run: |
          $scriptUrl = "${{ vars.SCRIPT_BASE_URL }}/${{ vars.CICD_SCRIPTS_VERSION }}/${{ vars.SCRIPT_RELATIVE_DIR_PATH }}";
          $scriptUrl = $scriptUrl.Replace("\", "/").Replace("//", "/");
          $scriptUrl = $scriptUrl.EndsWith("/") ? $scriptUrl.Substring(0, $scriptUrl.Length - 1) : $scriptUrl;
          $scriptUrl = "$scriptUrl/close-milestone.ts";

          Write-Host "::notice::Close milestone script URL: $scriptUrl";

          <# Deno Args:
            1. Project name
            2. Milestone name - This is the version
            3. PAT
          #>
          deno run `
            -R `
            -N `
            "$scriptUrl" `
            "${{ vars.PROJECT_NAME }}" `
            "${{ needs.get_version.outputs.version }}" `
            "${{ secrets.CICD_TOKEN }}";
